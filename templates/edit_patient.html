<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Patient - WellSaid AI Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        @layer components {
            .btn { @apply font-bold py-2 px-4 rounded-lg shadow transition-all duration-150 ease-in-out; }
            .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700 active:bg-blue-800; }
            .btn-secondary { @apply bg-gray-200 text-gray-800 hover:bg-gray-300 active:bg-gray-400; }
            .btn-danger { @apply bg-red-500 text-white hover:bg-red-600; }
            .form-input { @apply block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6; }
            .form-select { @apply block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6; }
            .form-label { @apply block text-sm font-medium leading-6 text-gray-900; }
        }
    </style>
</head>
<body class="h-full font-sans antialiased">
    <div class="min-h-full">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <!-- FIX: Title is now "WellSaid AI Demo" and links to the dashboard -->
                <a href="{{ url_for('dashboard') }}" class="text-2xl font-bold text-gray-900">WellSaid AI Demo</a>
                <!-- FIX: This "Cancel" link now correctly points to the patient detail page -->
                <a href="{{ url_for('patient_detail', clinic_id=patient.clinic_id, mrn=patient.mrn) }}" class="btn btn-secondary">Cancel</a>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="py-10">
            <div class="container mx-auto max-w-3xl px-4 sm:px-6 lg:px-8">

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="mb-4">
                        {% for category, message in messages %}
                            <div class="rounded-md p-4 {{ 'bg-red-100 border-red-400 text-red-700' if category == 'danger' else 'bg-green-100 border-green-400 text-green-700' if category == 'success' else 'bg-blue-100 border-blue-400 text-blue-700' }}" role="alert">
                                <p class="font-bold"><strong>{{ category.title() }}</strong></p>
                                <p>{{ message }}</p>
                            </div>
                        {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                <form action="{{ url_for('edit_patient', clinic_id=patient.clinic_id, mrn=patient.mrn) }}" method="POST" class="bg-white p-8 rounded-lg shadow space-y-8">
                    
                    <!-- Core Info -->
                    <div class="border-b border-gray-900/10 pb-8">
                        <!-- FIX: Moved Page Title from header to here -->
                        <h2 class="text-base font-semibold leading-7 text-gray-900">Edit Patient: {{ patient.name }}</h2>
                        <p class="mt-1 text-sm leading-6 text-gray-600">Use YYYY-MM-DD for dates.</p>

                        <div class="mt-6 grid grid-cols-1 gap-x-6 gap-y-6 sm:grid-cols-6">
                            <div class="sm:col-span-3">
                                <label for="name" class="form-label">Full Name*</label>
                                <input type="text" name="name" id="name" value="{{ patient.get('name', '') }}" class="form-input" required>
                            </div>
                            <div class="sm:col-span-3">
                                <label for="dob" class="form-label">Date of Birth* (YYYY-MM-DD)</label>
                                <input type="text" name="dob" id="dob" value="{{ patient.get('dob', '') }}" class="form-input" placeholder="YYYY-MM-DD" required>
                            </div>
                            <div class="sm:col-span-3">
                                <label for="mrn" class="form-label">MRN*</label>
                                <input type="text" name="mrn" id="mrn" value="{{ patient.get('mrn', '') }}" class="form-input" required>
                            </div>
                            <div class="sm:col-span-3">
                                <label for="clinic_id" class="form-label">Clinic*</label>
                                <select id="clinic_id" name="clinic_id" class="form-select" required>
                                    <option value="">Select a clinic</option>
                                    {% for clinic in clinics %}
                                    <option value="{{ clinic.id }}" {% if clinic.id == patient.get('clinic_id', '') %}selected{% endif %}>{{ clinic.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="sm:col-span-6">
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="tel" name="phone" id="phone" value="{{ patient.get('phone', '') }}" class="form-input" placeholder="+1 (555) 123-4567">
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic List Fields -->
                    {% set list_fields = [
                        ('medications', 'Medications'),
                        ('allergies', 'Allergies'),
                        ('medical_conditions', 'Medical Conditions'),
                        ('procedures_history', 'Procedures History')
                    ] %}
                    
                    {% for name, title in list_fields %}
                    <div class="border-b border-gray-900/10 pb-8">
                        <div class="flex justify-between items-center">
                            <h2 class="text-base font-semibold leading-7 text-gray-900">{{ title }}</h2>
                            <button type="button" class="btn btn-secondary btn-sm !py-1 !px-2" onclick="addDynamicItem('{{ name }}')">Add</button>
                        </div>
                        <div id="{{ name }}-list" class="mt-4 space-y-2">
                            {% for item in patient.get(name, []) %}
                            <div class="flex items-center gap-x-4">
                                <input type="text" name="{{ name }}[]" value="{{ item }}" class="form-input">
                                <button type="button" class="btn btn-danger btn-sm !py-1 !px-2" onclick="removeItem(this)">Remove</button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- Encounters -->
                    <div class="border-b border-gray-900/10 pb-8">
                        <div class="flex justify-between items-center">
                            <h2 class="text-base font-semibold leading-7 text-gray-900">Encounters</h2>
                            <button type="button" class="btn btn-secondary btn-sm !py-1 !px-2" onclick="addEncounterItem()">Add Encounter</button>
                        </div>
                        <div id="encounters-list" class="mt-4 space-y-4">
                            {% for date, encounter in patient.get('encounters', {}).items() %}
                            <div class="encounter-item grid grid-cols-1 sm:grid-cols-5 gap-x-4 gap-y-2 p-4 border rounded-md relative">
                                <button type="button" class="btn btn-danger btn-sm !py-1 !px-2 absolute -top-2 -right-2" onclick="removeItem(this.parentElement)">X</button>
                                <div class="sm:col-span-2">
                                    <label class="form-label">Date (YYYY-MM-DD)</label>
                                    <input type="text" name="encounter_date[]" value="{{ date }}" class="form-input" placeholder="YYYY-MM-DD">
                                </div>
                                <div class="sm:col-span-3">
                                    <label class="form-label">Type</label>
                                    <input type="text" name="encounter_type[]" value="{{ encounter.type }}" class="form-input">
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="form-label">Status</label>
                                    <select name="encounter_status[]" class="form-select">
                                        <option value="scheduled" {% if encounter.status == 'scheduled' %}selected{% endif %}>Scheduled</option>
                                        <option value="completed" {% if encounter.status == 'completed' %}selected{% endif %}>Completed</option>
                                        <option value="signed" {% if encounter.status == 'signed' %}selected{% endif %}>Signed</option>
                                        <option value="cancelled" {% if encounter.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                                    </select>
                                </div>
                                <div class="sm:col-span-3">
                                    <label class="form-label">Purpose</label>
                                    <input type="text" name="encounter_purpose[]" value="{{ encounter.purpose }}" class="form-input">
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="mt-6 flex items-center justify-end gap-x-6">
                        <!-- FIX: This "Cancel" link now correctly points to the patient detail page -->
                        <a href="{{ url_for('patient_detail', clinic_id=patient.clinic_id, mrn=patient.mrn) }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>

            </div>
        </main>
    </div>

    <script>
        function addDynamicItem(listName) {
            const list = document.getElementById(listName + '-list');
            const newItem = document.createElement('div');
            newItem.className = 'flex items-center gap-x-4';
            newItem.innerHTML = `
                <input type="text" name="${listName}[]" class="form-input" placeholder="New entry...">
                <button type="button" class="btn btn-danger btn-sm !py-1 !px-2" onclick="removeItem(this)">Remove</button>
            `;
            list.appendChild(newItem);
        }

        function addEncounterItem() {
            const list = document.getElementById('encounters-list');
            const newItem = document.createElement('div');
            newItem.className = 'encounter-item grid grid-cols-1 sm:grid-cols-5 gap-x-4 gap-y-2 p-4 border rounded-md relative';
            newItem.innerHTML = `
                <button type="button" class="btn btn-danger btn-sm !py-1 !px-2 absolute -top-2 -right-2" onclick="removeItem(this.parentElement)">X</button>
                <div class="sm:col-span-2">
                    <label class="form-label">Date (YYYY-MM-DD)</label>
                    <input type="text" name="encounter_date[]" class="form-input" placeholder="YYYY-MM-DD">
                </div>
                <div class="sm:col-span-3">
                    <label class="form-label">Type</label>
                    <input type="text" name="encounter_type[]" class="form-input" placeholder="e.g., AI phone call">
                </div>
                <div class="sm:col-span-2">
                    <label class="form-label">Status</label>
                    <select name="encounter_status[]" class="form-select">
                        <option value="scheduled">Scheduled</option>
                        <option value="completed">Completed</option>
                        <option value="signed">Signed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="sm:col-span-3">
                    <label class="form-label">Purpose</label>
                    <input type="text" name="encounter_purpose[]" class="form-input" placeholder="e.g., Medication adherence">
                </div>
            `;
            list.appendChild(newItem);
        }

        function removeItem(button) {
            button.parentElement.remove();
        }
    </script>
</body>
</html>

