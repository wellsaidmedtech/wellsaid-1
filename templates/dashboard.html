<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        @layer utilities {
            .btn {
                @apply font-bold py-2 px-4 rounded-lg shadow transition-all duration-200;
            }
            .btn-primary {
                @apply bg-blue-600 text-white hover:bg-blue-700;
            }
            .btn-secondary {
                @apply bg-gray-200 text-gray-800 hover:bg-gray-300;
            }
            .btn-danger {
                @apply bg-red-600 text-white hover:bg-red-700;
            }
            .btn-outline {
                @apply bg-transparent border border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white;
            }
            .card {
                @apply bg-white shadow-lg rounded-lg overflow-hidden;
            }
            .input-field {
                @apply block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm;
            }
            .table-cell {
                @apply px-5 py-3 border-b-2 border-gray-200 bg-white text-sm;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <!-- Header Navigation -->
    <nav class="bg-white shadow-md p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="text-2xl font-bold text-blue-600">AI Patient Dashboard</div>
            <div>
                <!-- NEW: Link to Prompt Editor -->
                <a href="{{ url_for('admin_prompts') }}" class="btn-secondary btn mr-2">Prompt Editor</a>
                <a href="{{ url_for('create_patient') }}" class="btn-primary btn">Create New Patient</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto p-8">

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="p-4 mb-4 rounded-md {{ 'bg-green-100 text-green-700' if category == 'success' else 'bg-red-100 text-red-700' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Server Tools Card -->
        <div class="card mb-6">
            <div class="p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Admin Tools</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <!-- Wake Up Server -->
                    <div class="flex-1">
                        <label for="render_url_display" class="block text-sm font-medium text-gray-700">Backend Server Status</label>
                        <div class="flex mt-1">
                            <input type="text" id="render_url_display" value="{{ render_url if render_url else 'RENDER_BACKEND_URL not set' }}" class="input-field bg-gray-50" readonly>
                            <button id="wakeUpButton" class="btn btn-outline ml-2 whitespace-nowrap">Wake Up Server</button>
                        </div>
                    </div>
                    <!-- Demo Phone Override -->
                    <div class="flex-1">
                        <label for="phone_override" class="block text-sm font-medium text-gray-700">Demo Phone Override</label>
                        <input type="tel" id="phone_override" name="phone_override" class="input-field mt-1" placeholder="Enter your phone # to intercept calls">
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient List Card -->
        <div class="card">
            <!-- Filter Bar -->
            <form method="GET" action="{{ url_for('dashboard') }}" class="p-6 border-b">
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <label for="patient_name" class="block text-sm font-medium text-gray-700">Filter by Name</label>
                        <input type="text" id="patient_name" name="patient_name" value="{{ patient_name }}" class="input-field mt-1" placeholder="e.g., Matt Damon">
                    </div>
                    <div class="flex-1">
                        <label for="clinic_id" class="block text-sm font-medium text-gray-700">Filter by Clinic</label>
                        <select id="clinic_id" name="clinic_id" class="input-field mt-1">
                            <option value="">All Clinics</option>
                            {% for clinic in clinics %}
                                <option value="{{ clinic.id }}" {% if clinic.id == selected_clinic %}selected{% endif %}>{{ clinic.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex-shrink-0 self-end">
                        <button type="submit" class="btn btn-primary mt-1 sm:mt-0">Apply Filter</button>
                    </div>
                </div>
            </form>

            <!-- Patient Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Patient Name
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                MRN / Clinic
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Phone
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Next Action
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for patient in patients %}
                            <tr>
                                <td class="table-cell">
                                    <p class="text-gray-900 whitespace-no-wrap">{{ patient.name }}</p>
                                    <p class="text-gray-600 whitespace-no-wrap text-xs">{{ patient.dob }}</p>
                                </td>
                                <td class="table-cell">
                                    <p class="text-gray-900 whitespace-no-wrap">{{ patient.mrn }}</p>
                                    <p class="text-gray-600 whitespace-no-wrap text-xs">
                                        {{ (clinics|selectattr('id', 'equalto', patient.clinic_id)|first).name | default('Unknown Clinic') }}
                                    </p>
                                </td>
                                <td class="table-cell">
                                    <p class="text-gray-900 whitespace-no-wrap">{{ patient.phone }}</p>
                                </td>
                                <td class="table-cell">
                                    {% set next_action = {'date': '9999', 'purpose': 'N/A'} %}
                                    {% if patient.encounters %}
                                        {% for date, enc in patient.encounters.items() %}
                                            {% if enc.status == 'scheduled' and date < next_action.date %}
                                                {% set_global next_action = {'date': date, 'purpose': enc.purpose} %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% if next_action.date != '9999' %}
                                        <p class="text-gray-900 whitespace-no-wrap">{{ next_action.date }}</g></p>
                                        <p class="text-gray-600 whitespace-no-wrap text-xs">{{ next_action.purpose }}</p>
                                    {% else %}
                                        <p class="text-gray-500 whitespace-no-wrap">None Scheduled</p>
                                    {% endif %}
                                </td>
                                <td class="table-cell space-x-2">
                                    <a href="{{ url_for('patient_detail', clinic_id=patient.clinic_id, mrn=patient.mrn) }}" class="btn btn-outline text-xs">View</a>
                                    <a href="{{ url_for('edit_patient', clinic_id=patient.clinic_id, mrn=patient.mrn) }}" class="btn btn-secondary text-xs">Edit</a>
                                    <button 
                                        class="btn btn-primary text-xs" 
                                        onclick="initiateCall(
                                            '{{ patient.phone }}',
                                            '{{ patient.mrn }}',
                                            '{{ patient.clinic_id }}'
                                        )">
                                        Call Patient
                                    </button>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="5" class="p-5 text-center text-gray-500">No patients found.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    const RENDER_BACKEND_URL = "{{ render_url | safe }}";

    function initiateCall(patientPhone, mrn, clinicId) {
        const phoneOverride = document.getElementById('phone_override').value;
        
        // Construct the query parameters
        const params = new URLSearchParams({
            phone: patientPhone,
            mrn: mrn,
            clinic_id: clinicId
        });

        if (phoneOverride) {
            params.append('phone_override', phoneOverride);
        }

        // Redirect to the /call endpoint
        window.location.href = `{{ url_for('call_patient') }}?${params.toString()}`;
    }

    // Server Wake Up
    const wakeUpButton = document.getElementById('wakeUpButton');
    if (wakeUpButton) {
        wakeUpButton.addEventListener('click', () => {
            if (!RENDER_BACKEND_URL || RENDER_BACKEND_URL === 'RENDER_BACKEND_URL not set') {
                wakeUpButton.textContent = "URL Not Set";
                wakeUpButton.classList.add('btn-danger');
                return;
            }

            wakeUpButton.textContent = "Pinging...";
            wakeUpButton.disabled = true;

            fetch(`${RENDER_BACKEND_URL}/wake-up`, { method: 'GET' })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Network response was not ok.');
                })
                .then(data => {
                    console.log(data);
                    wakeUpButton.textContent = "Server Awake!";
                    wakeUpButton.classList.remove('btn-outline');
                    wakeUpButton.classList.add('bg-green-500', 'text-white');
                })
                .catch(error => {
                    console.error('Fetch Error:', error);
                    wakeUpButton.textContent = "Ping Failed";
                    wakeUpButton.classList.remove('btn-outline');
                    wakeUpButton.classList.add('btn-danger');
                })
                .finally(() => {
                    wakeUpButton.disabled = false;
                    setTimeout(() => {
                        wakeUpButton.textContent = "Wake Up Server";
                        wakeUpButton.classList.remove('bg-green-500', 'text-white', 'btn-danger');
                        wakeUpButton.classList.add('btn-outline');
                    }, 3000);
                });
        });
    }
</script>
</body>
</html>

