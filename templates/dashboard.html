<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - WellSaid AI Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        /* Custom styles for buttons */
        @layer components {
            .btn {
                @apply font-bold py-2 px-4 rounded-lg shadow transition-all duration-150 ease-in-out;
            }
            .btn-primary {
                @apply bg-blue-600 text-white hover:bg-blue-700 active:bg-blue-800;
            }
            .btn-secondary {
                @apply bg-gray-200 text-gray-800 hover:bg-gray-300 active:bg-gray-400;
            }
            .btn-success {
                @apply bg-green-600 text-white hover:bg-green-700;
            }
            .btn-danger {
                @apply bg-red-600 text-white hover:bg-red-700;
            }
            .btn-link {
                @apply text-blue-600 hover:text-blue-800 hover:underline;
            }

            /* Form Input Styles */
            .form-input {
                @apply block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6;
            }
            .form-select {
                @apply block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6;
            }
            .form-label {
                @apply block text-sm font-medium leading-6 text-gray-900;
            }
        }
    </style>
</head>
<body class="h-full font-sans antialiased">
    <div class="min-h-full">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <!-- FIX: Title is now "WellSaid AI Demo" and links to the dashboard -->
                <a href="{{ url_for('dashboard') }}" class="text-2xl font-bold text-gray-900">WellSaid AI Demo</a>
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('admin_prompts') }}" class="btn-link">Prompt Editor</a>
                    <a href="{{ url_for('create_patient') }}" class="btn btn-primary">Create Patient</a>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="py-10">
            <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="mb-4">
                        {% for category, message in messages %}
                            <div class="rounded-md p-4 {{ 'bg-red-100 border-red-400 text-red-700' if category == 'danger' else 'bg-green-100 border-green-400 text-green-700' if category == 'success' else 'bg-blue-100 border-blue-400 text-blue-700' }}" role="alert">
                                <p class="font-bold"><strong>{{ category.title() }}</strong></p>
                                <p>{{ message }}</p>
                            </div>
                        {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                <!-- Filters -->
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <form method="GET" action="{{ url_for('dashboard') }}" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="patient_name" class="form-label">Patient Name</label>
                            <input type="text" name="patient_name" id="patient_name" value="{{ patient_name }}" class="form-input" placeholder="e.g., Matt Damon">
                        </div>
                        <div>
                            <label for="clinic_id" class="form-label">Clinic</label>
                            <select name="clinic_id" id="clinic_id" class="form-select">
                                <option value="">All Clinics</option>
                                {% for clinic in clinics %}
                                    <option value="{{ clinic.id }}" {% if clinic.id == selected_clinic %}selected{% endif %}>{{ clinic.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="self-end">
                            <button type="submit" class="btn btn-primary w-full sm:w-auto">Apply Filter</button>
                        </div>
                    </form>
                </div>

                <!-- Server Tools -->
                <div class="bg-white p-6 rounded-lg shadow mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                    <div class="flex-1 w-full sm:w-auto">
                        <label for="phone_override" class="form-label">Demo Phone Override</label>
                        <input type="tel" id="phone_override" class="form-input" placeholder="Enter your phone # to receive calls (e.g., +15551234567)">
                    </div>
                    <div class="w-full sm:w-auto flex-shrink-0">
                         <label class="form-label invisible hidden sm:block">Server Status</label>
                        <button id="wake-up-btn" type="button" class="btn btn-secondary w-full">
                            Wake Up Server
                        </button>
                    </div>
                </div>

                <!-- Patient List -->
                <div class="bg-white shadow sm:rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MRN</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DOB</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Next Action</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% if patients %}
                                    {% for patient in patients %}
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <!-- FIX: This link should now work correctly. -->
                                                <a href="{{ url_for('patient_detail', clinic_id=patient.clinic_id, mrn=patient.mrn) }}" class="text-sm font-medium text-blue-600 hover:text-blue-800">
                                                    {{ patient.name }}
                                                </a>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ patient.mrn }}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ patient.dob }}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ patient.phone }}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                {% if patient.next_action.date %}
                                                    <span class="font-medium">{{ patient.next_action.date }}</span>
                                                    <span class="block text-xs text-gray-400">{{ patient.next_action.purpose }}</span>
                                                {% else %}
                                                    <span class="text-gray-400">{{ patient.next_action.purpose }}</span>
                                                {% endif %}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                <!-- Call Patient Form -->
                                                <form action="{{ url_for('call_patient') }}" method="GET" class="inline-block call-patient-form">
                                                    <input type="hidden" name="phone" value="{{ patient.phone }}">
                                                    <input type="hidden" name="mrn" value="{{ patient.mrn }}">
                                                    <input type="hidden" name="clinic_id" value="{{ patient.clinic_id }}">
                                                    <button type="submit" class="btn btn-primary btn-sm !py-1 !px-2">
                                                        Call
                                                    </button>
                                                </form>
                                                <!-- Edit Patient Link -->
                                                <a href="{{ url_for('edit_patient', clinic_id=patient.clinic_id, mrn=patient.mrn) }}" class="btn btn-secondary btn-sm !py-1 !px-2">
                                                    Edit
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                            No patients found.
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Server Wake-Up Function
        const wakeUpBtn = document.getElementById('wake-up-btn');
        const renderUrl = "{{ render_url }}"; // Get URL from Jinja

        async function wakeUpServer() {
            if (!renderUrl) {
                wakeUpBtn.textContent = 'Backend URL Not Set';
                wakeUpBtn.classList.remove('btn-secondary');
                wakeUpBtn.classList.add('btn-danger');
                return;
            }
            
            wakeUpBtn.textContent = 'Pinging...';
            wakeUpBtn.disabled = true;

            try {
                // We add the /wake-up endpoint we created
                const response = await fetch(`${renderUrl}/wake-up`);
                
                if (response.ok) {
                    wakeUpBtn.textContent = 'Server Awake';
                    wakeUpBtn.classList.remove('btn-secondary', 'btn-danger');
                    wakeUpBtn.classList.add('btn-success');
                } else {
                    throw new Error(`Server responded with ${response.status}`);
                }
            } catch (error) {
                console.error('Wake-up ping failed:', error);
                wakeUpBtn.textContent = 'Ping Failed';
                wakeUpBtn.classList.remove('btn-secondary', 'btn-success');
                wakeUpBtn.classList.add('btn-danger');
            } finally {
                wakeUpBtn.disabled = false;
                setTimeout(() => {
                    wakeUpBtn.textContent = 'Wake Up Server';
                    wakeUpBtn.classList.remove('btn-success', 'btn-danger');
                    wakeUpBtn.classList.add('btn-secondary');
                }, 4000);
            }
        }

        wakeUpBtn.addEventListener('click', wakeUpServer);

        // Call Override Function
        const phoneOverrideInput = document.getElementById('phone_override');
        // Get all forms with the specific action
        const callForms = document.querySelectorAll('form[action="{{ url_for("call_patient") }}"]');

        callForms.forEach(form => {
            form.addEventListener('submit', function(event) {
                // Stop the form from submitting immediately
                event.preventDefault(); 
                
                const overrideValue = phoneOverrideInput.value.trim();
                
                if (overrideValue) {
                    // If there's an override, add it as a new hidden input
                    let overrideInput = form.querySelector('input[name="phone_override"]');
                    if (!overrideInput) {
                        overrideInput = document.createElement('input');
                        overrideInput.type = 'hidden';
                        overrideInput.name = 'phone_override';
                        form.appendChild(overrideInput);
                    }
                    overrideInput.value = overrideValue;
                }
                
                // Now, submit the form with the (potentially) added override
                form.submit();
            });
        });
    </script>
</body>
</html>

